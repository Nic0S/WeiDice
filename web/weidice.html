<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WeiDice Frontend</title>
    <script language="javascript" type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="weidice_abi.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>

<body>
<label for="contract"> Contract Address:</label>
<input type="text" id="contract">
<div>
    <button onclick="connectAndReload().then(() => status('Connected.'))">Connect</button>
</div>
<p></p>
<div><label for="status">Status: </label>
    <p id="status"></p></div>
<p></p>

<div id="loggedIn" hidden>
    <div><label for="userBalance">User balance: </label>
        <p id="userBalance"></p></div>

    <label for="wager"> Wager (ETH):</label>
    <input type="number" id="wager" value="0.001">
    <p></p>
    <div>
        <button onclick="roll()">Roll!</button>
    </div>
    <p></p>
    <div><label for="contractBalance">Contract balance: </label>
        <p id="contractBalance"></p></div>
    <div><label for="events">Events: </label>
        <div id="events"></div>
    </div>
</div>
<script>
  let contract;
  let account;
  let web3;
  let weiDice;

  function startApp() {
    const params = new URLSearchParams(window.location.search);
    $("#contract").val(params.get('contract'))
    status("Please click \"Connect\" to get started.")
  }

  async function connectAndReload() {
    const accounts = await ethereum.request({method: 'eth_requestAccounts'});
    account = accounts[0]

    const bal = await web3.eth.getBalance(account)
    $("#userBalance").text(web3.utils.fromWei(bal.toString()) + " ETH");

    contract = $("#contract").val();
    const cBal = await web3.eth.getBalance(contract)
    $("#contractBalance").text(web3.utils.fromWei(cBal.toString()) + " ETH");

    weiDice = new web3.eth.Contract(weiDiceABI, contract);

    let opts = {
      filter: {
        roller: account,
      },
      fromBlock: 0,
    }
    weiDice.events.Rolled(opts)
      .on('data', e => event(e))

    clearInterval()
    setInterval(async function () {
      const accounts = await ethereum.request({method: 'eth_requestAccounts'});
      if (accounts[0] !== account) {
        account = accounts[0];
        await connectAndReload()
      }
    }, 500);


    $("#loggedIn").removeAttr("hidden")
  }

  function roll() {
    status("Sending roll transaction...")
    value = $("#wager").val()
    weiDice.methods.roll()
      .send({from: account, value: web3.utils.toWei(value.toString(), "ether")})
      .on("receipt", (receipt) => {
        status("Transaction sent! Results will appear below")
      })
      .on("error", (error) => {
        status(error.message)
        console.log(error)
      })
  }

  function event(e) {
    let eStr = "Block: " + e.blockNumber
    if (e.returnValues.won) {
      eStr += " Winnings: " + web3.utils.fromWei(e.returnValues.wonAmount.toString())
    } else {
      eStr += " Lost"
    }
    var entry = document.createElement("p");
    entry.appendChild(document.createTextNode(eStr))
    $("#events").prepend(entry)
  }

  function status(message) {
    $("#status").text(message);
  }

  window.addEventListener('load', function () {
    status("Starting...");
    if (typeof window.ethereum !== 'undefined') {
      web3 = new Web3(window.ethereum)
      startApp()
    } else {
      status("Please make sure metamask is installed and refresh the page.")
    }
  })
</script>
<script>
</script>
</body>
</html>